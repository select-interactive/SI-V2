!function(a,b){window.SI=window.SI||{};var c,d,e;SI.admin=SI.admin||{},SI.admin.news={settings:{newsId:-1,datePosted:"",primaryPic:"",thumbPic:"",wsUrl:"/webservices/wsNews.asmx/",wsDisplaymode:3,editorOptions:{allowedContent:!0,toolbar:"Simple"}},elements:{formOptions:a.getElementById("form-option"),ddlEntries:a.getElementById("ddl-entries"),btnNew:a.getElementById("btn-new"),formNews:a.getElementById("form-news"),dataFields:a.querySelectorAll("[data-field]"),ddlTags:a.getElementById("ddl-tags"),cbIsActive:a.getElementById("cb-is-active"),btnEntrySave:a.getElementById("btn-entry-save"),btnEntryCancel:a.getElementById("btn-entry-cancel"),btnEntryDelete:a.getElementById("btn-entry-delete"),btnEntryPreview:a.getElementById("btn-entry-preview"),status:a.getElementById("status")},init:function(){c=this,d=c.settings,e=c.elements,c.bindEvents(),CKEDITOR.replace("ta-body",d.editorOptions),CKEDITOR.replace("ta-summary",d.editorOptions),b(e.ddlTags).select2({placeholder:"Select Tags"})},bindEvents:function(){e.ddlEntries.addEventListener("change",c.loadEntryDetails,!1),e.btnNew.addEventListener("click",c.startNewEntry,!1),e.btnEntrySave.addEventListener("click",c.saveEntry,!1),e.btnEntryCancel.addEventListener("click",c.cancel,!1),e.btnEntryDelete.addEventListener("click",c.deleteEntry,!1),e.btnEntryPreview.addEventListener("click",c.previewEntry,!1)},loadEntryDetails:function(){function a(){return SI.ajax(d.wsUrl+"loadNewsItemsAsJson",{newsId:d.newsId,search:"",webUrl:"",tagUrl:"",isActive:!1,start:1,max:-1})}function c(){return SI.ajax(d.wsUrl+"loadTagsAsJson",{tagId:-1,newsId:d.newsId})}e.status.innerHTML='<p class="info">Loading entry details, please wait...</p>',d.newsId=parseInt(e.ddlEntries.value,10),b.when(a(),c()).then(function(a,c){if(a&&c){var f,g,h,i=e.dataFields,j=0,k=i.length,l=[];for(a=a[0].d[0].cols;k>j;j++)f=i[j],g=f.getAttribute("data-field"),h=a[g],"textarea"===f.tagName.toString().toLowerCase()?CKEDITOR.instances[f.id].setData(h):f.value=h;for(e.cbIsActive.checked=a.isActive?!0:!1,d.primaryPic=a.primaryPic,d.thumbPic=a.thumbPic,c=c[0].d,j=0,k=c.length;k>j;j++)l.push(c[j].cols.tagId);b(e.ddlTags).select2("val",l),d.datePosted=moment(a.datePosted).format("YYYY-MM-DD HH:mm:ss"),e.btnEntryPreview.setAttribute("data-url",a.webUrl),e.btnEntryDelete.classList.remove("hidden"),e.btnEntryPreview.classList.remove("hidden"),e.formOptions.classList.add("hidden"),e.formNews.classList.remove("hidden"),e.status.innerHTML=""}})},startNewEntry:function(){c.resetForm(),e.btnEntryDelete.classList.add("hidden"),e.btnEntryPreview.classList.add("hidden"),e.formOptions.classList.add("hidden"),e.formNews.classList.remove("hidden"),e.formNews.querySelectorAll("input")[0].focus()},saveEntry:function(){for(var a,f,g,h=!1,i=e.formNews.querySelectorAll(".req"),j=e.dataFields,k=0,l=i.length,m={};l>k;k++)a=i[k],g="textarea"===a.tagName.toString().toLowerCase()?b.trim(CKEDITOR.instances[a.id].getData()):b.trim(a.value),""===g?(a.classList.add("invalid"),h=!0):a.classList.remove("invalid");if(h)return e.formNews.querySelectorAll(".invalid")[0].focus(),void 0;for(e.status.innerHTML='<p class="info">Saving entry, please wait...</p>',k=0,l=j.length;l>k;k++)a=j[k],f=a.getAttribute("data-field"),g="textarea"===a.tagName.toString().toLowerCase()?b.trim(CKEDITOR.instances[a.id].getData()):b.trim(a.value),m[f]=g;m.newsId=d.newsId,m.datePosted=d.datePosted,m.primaryPic=d.primaryPic,m.thumbPic=d.thumbPic,m.isActive=e.cbIsActive.checked,m.tags=b(e.ddlTags).val(),SI.ajax(d.wsUrl+"saveEntry",m,function(a){if(a&&a.d){var b=JSON.parse(a.d);b&&b.status&&"success"===b.status?(e.status.innerHTML='<p class="success">The entry has been saved successfully.</p>',d.newsId=b.newsId,c.loadEntries(),e.btnEntryDelete.classList.remove("hidden"),e.btnEntryPreview.classList.remove("hidden"),setTimeout(function(){e.status.innerHTML=""},1e3)):e.status.innerHTML='<p class="error">Unable to save entry at this time.'+(b.msg?b.msg:"")+"</p>"}})},cancel:function(){confirm("Are you sure you want to leave the entry form?")&&(e.formNews.classList.add("hidden"),e.formOptions.classList.remove("hidden"),d.newsId=-1,c.loadEntries(),e.ddlEntries.value="-1",window.scrollTo(0,0))},deleteEntry:function(){confirm("Are you sure you want to delete this entry?")&&(e.status.innerHTML='<p class="info">Deleting entry, please wait...</p>',SI.ajax(d.wsUrl+"deleteEntry",{newsId:d.newsId},function(a){if(a&&a.d){var b=JSON.parse(a.d);b&&b.status&&"success"===b.status?(e.status.innerHTML='<p class="success">The entry has been deleted successfully.</p>',d.newsId=-1,c.loadEntries(),setTimeout(function(){c.resetForm(),e.formNews.classList.add("hidden"),e.formOptions.classList.remove("hidden"),e.status.innerHTML=""},1e3)):e.status.innerHTML='<p class="error">Unable to delete the entry at this time.'+(b.msg?b.msg:"")+"</p>"}}))},previewEntry:function(){var a="/news/"+this.getAttribute("data-url");window.open(a,"_blank")},resetForm:function(){d.newsId=-1,d.datePosted="",d.primaryPic="",d.thumbPic="";for(var a=e.formNews.querySelectorAll("input[type=text], input[type=url]"),c=0,f=a.length;f>c;c++)a[c].value="";CKEDITOR.instances["ta-body"].setData(""),CKEDITOR.instances["ta-summary"].setData(""),b(e.ddlTags).select2("val",[]),e.cbIsActive.checked=!1,window.scrollTo(0,0)},loadEntries:function(){SI.ajax(d.wsUrl+"loadNewsItemsAsHtml",{newsId:-1,search:"",webUrl:"",tagUrl:"",isActive:!1,start:1,max:-1,displayMode:d.wsDisplaymode},function(a){a&&a.d&&(e.ddlEntries.innerHTML=a.d)})}},SI.admin.news.init()}(document,jQuery);